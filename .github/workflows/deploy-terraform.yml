name: ðŸš€ CI & Deploy with Dynamic Terraform Outputs

on:
  push:
    branches: [ main ]

jobs:
  # â”€â”€â”€ 1) Run your tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: [node, react]

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with: { node-version: '20' }

      - name: Install & test `${{ matrix.dir }}`
        working-directory: ${{ matrix.dir }}
        run: |
          npm install
          npm test

  # â”€â”€â”€ 2) Deploy to Terraform-managed infrastructure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ Deploy to Terraform EC2
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # â€”â€”â€” 2.1 Setup Terraform â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false  # Important: allows raw output

      # â€”â€”â€” 2.2 Configure AWS credentials â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      # â€”â€”â€” 2.3 Create terraform.tfvars from secrets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Create terraform.tfvars
        run: |
          cd terraform
          cat > terraform.tfvars << EOF
          # Auto-generated from GitHub secrets
          ssh_public_key = "${{ secrets.SSH_PUBLIC_KEY }}"
          db_password = "${{ secrets.DB_PASSWORD }}"
          jwt_secret = "${{ secrets.JWT_SECRET }}"
          
          # Configuration
          aws_region = "eu-west-1"
          project_name = "ecommerce-app"
          environment = "production"
          domain_name = "glamprinakis.com"
          instance_type = "t3.medium"
          root_volume_size = 20
          ssh_allowed_ips = ["0.0.0.0/0"]  # GitHub Actions IPs are dynamic
          backup_retention_days = 7
          
          tags = {
            Owner       = "Georgios Lamprinakis"
            Project     = "E-commerce Portfolio"
            Environment = "Production"
            DeployedBy  = "GitHub Actions"
          }
          EOF

      # â€”â€”â€” 2.4 Get Terraform outputs â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Get server IP from Terraform
        id: terraform
        run: |
          cd terraform
          terraform init
          
          # Get the instance IP from Terraform state
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
          
          if [ -z "$INSTANCE_IP" ] || [ "$INSTANCE_IP" = "null" ]; then
            echo "âŒ Could not get instance IP from Terraform"
            exit 1
          fi
          
          echo "ðŸŽ¯ Found server IP: $INSTANCE_IP"
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

      # â€”â€”â€” 2.5 Install SSH key â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      # â€”â€”â€” 2.6 Add EC2 to known_hosts â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Add EC2 to known_hosts
        run: |
          ssh-keyscan -H "${{ steps.terraform.outputs.instance_ip }}" >> ~/.ssh/known_hosts

      # â€”â€”â€” 2.7 Deploy to Terraform-managed EC2 â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ubuntu@${{ steps.terraform.outputs.instance_ip }} << 'EOF'
            
            set -e
            cd ~/Web3

            echo "ðŸ”„ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main

            echo "ðŸ§± Building full stack (frontend, proxy, backend)..."
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate --no-deps

            echo "ðŸ§¹ Cleaning up old Docker resources..."
            docker image prune -f
            docker container prune -f
            docker network prune -f
            docker volume prune -f

            echo "â³ Waiting for health check..."
            sleep 5
            if ! curl -sf http://localhost/api/health; then
              echo "âŒ Health check failed!"
              exit 1
            fi

            echo "âœ… Deployment complete and healthy!"
            echo "ðŸ“Š Docker space usage after cleanup:"
            docker system df
            
            echo "ðŸŽ‰ Deployment successful at $(date)"
          EOF

      # â€”â€”â€” 2.8 Notify on failure â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Notify on deployment failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above for details."
